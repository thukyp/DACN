@{
    ViewData["Title"] = "Live Chat";
    // Layout = ... (Nếu bạn dùng layout)
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin - @ViewData["Title"]</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

    <style>
        #messages {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            background-color: #f8f9fa;
            display: flex;
            flex-direction: column;
        }

        .message {
            display: inline-block;
            padding: 10px 14px;
            margin: 6px 0;
            border-radius: 15px;
            max-width: 75%;
            word-wrap: break-word;
            line-height: 1.4;
        }

            .message.user {
                align-self: flex-start;
                background-color: #e9ecef; /* màu xám nhẹ cho KH */
                color: #212529;
                border: 1px solid #dee2e6;
            }

            .message.admin {
                align-self: flex-end;
                background-color: #0d6efd; /* xanh dương cho Admin */
                color: white;
            }

        .container {
            display: grid;
            max-width: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            flex-direction: row;
        }

        .sidebar {
            background-color: #212529;
            color: #fff;
            padding: 15px;
            width: 250px;
            flex-shrink: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

            .sidebar h4 {
                border-bottom: 1px solid #495057;
                padding-bottom: 10px;
                font-size: 1.25rem;
                margin-bottom: 1rem;
                font-weight: 600;
            }

            .sidebar .nav {
                flex-grow: 1;
            }

            .sidebar .nav-link {
                color: #adb5bd;
                padding: 8px 15px;
                border-radius: 0.25rem;
                margin-bottom: 5px;
                font-size: 0.9rem;
            }

                .sidebar .nav-link.active, .sidebar .nav-link:hover {
                    color: #fff;
                    background-color: #495057;
                }

            .sidebar .nav-item.mt-auto {
                margin-top: auto;
                border-top: 1px solid #495057;
                padding-top: 15px;
            }

            .sidebar .logout-form button {
                padding: 8px 15px;
                color: #dc3545;
                background: none;
                border: none;
                width: 100%;
                text-align: left;
                font-size: 0.9rem;
            }

                .sidebar .logout-form button:hover {
                    background-color: rgba(220, 53, 69, 0.1);
                    color: #bd2130;
                }

        .main-content {
            padding: 20px;
            background-color: #f8f9fa;
        }
    </style>

    <style>
        #chat-container {
            display: flex;
            height: calc(100vh - 120px); /* Chiều cao linh hoạt */
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        #user-list-container {
            width: 300px;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
        }

        #user-list-header {
            padding: 15px;
            font-weight: 600;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        #user-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex-grow: 1;
        }

            #user-list li {
                padding: 15px;
                cursor: pointer;
                border-bottom: 1px solid #eee;
                position: relative;
            }

                #user-list li:hover {
                    background: #f5f5f5;
                }

                #user-list li.active {
                    background: #e0e0e0;
                }

            #user-list .user-name {
                font-weight: 500;
            }

            #user-list .last-message {
                font-size: 0.9em;
                color: #666;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            #user-list .unread-badge {
                position: absolute;
                right: 15px;
                top: 50%;
                transform: translateY(-50%);
                background: #dc3545;
                color: white;
                font-size: 0.75em;
                padding: 2px 6px;
                border-radius: 10px;
                display: none; /* Ẩn ban đầu */
            }

            #user-list li.has-unread .unread-badge {
                display: block;
            }


        #chat-window {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        #chat-window-header {
            padding: 15px;
            font-weight: 600;
            border-bottom: 1px solid #eee;
            background: #f8f9fa;
        }

        #messages {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            background: #fdfdfd;
        }

        .chat-message {
            padding: 8px 12px;
            border-radius: 18px;
            margin-bottom: 10px;
            max-width: 70%;
            line-height: 1.4;
        }

            .chat-message.user {
                background: #e9ecef;
                color: #333;
                align-self: flex-start;
            }

            .chat-message.admin {
                background: #0d6efd;
                color: white;
                align-self: flex-end;
            }


        #reply-area {
            display: flex;
            padding: 15px;
            border-top: 1px solid #ddd;
            background: #f8f9fa;
        }

        #reply-input {
            flex-grow: 1;
            border-radius: 20px;
            border: 1px solid #ccc;
            padding: 10px 15px;
        }

        #reply-send-btn {
            border-radius: 50%;
            width: 40px;
            height: 40px;
            margin-left: 10px;
        }

        .image-bubble {
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* Mặc định là admin */
            background: transparent !important;
            padding: 6px;
            border-radius: 12px;
        }

        .message.user .image-bubble {
            align-items: flex-start; /* Nếu là khách */
        }

        .chat-image {
            max-width: 220px;
            max-height: 220px;
            border-radius: 10px;
            object-fit: cover;
            margin-bottom: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

            .chat-image:hover {
                transform: scale(1.03);
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            }

        .image-bubble .time {
            font-size: 0.75rem;
            color: #6c757d;
            align-self: flex-end;
        }

        .image-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            padding-top: 60px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }

            .image-modal img {
                margin: auto;
                display: block;
                max-width: 90%;
                max-height: 85%;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            }

            .image-modal .close-modal {
                position: absolute;
                top: 20px;
                right: 35px;
                color: #fff;
                font-size: 40px;
                font-weight: bold;
                cursor: pointer;
                transition: 0.2s;
            }

                .image-modal .close-modal:hover {
                    color: #ccc;
                }


    </style>
</head>
<body>
    <div class="d-flex">
        <div class="sidebar">
            <h4>Quản Lý ND</h4>
            <ul class="nav flex-column">
                <li class="nav-item"><a asp-area="QuanlyND" asp-controller="QuanlyND" asp-action="Index" class="nav-link "><i class="fas fa-users me-2"></i> Quản lý Tài khoản</a></li>
                <li class="nav-item"><a asp-area="QuanlyND" asp-controller="QuanlyPhanHoi" asp-action="Index" class="nav-link"><i class="fas fa-comments me-2"></i> Phản hồi & Đánh giá</a></li>
                <li class="nav-item"><a asp-area="QuanlyND" asp-controller="QuanlyHoTro" asp-action="Index" class="nav-link active"><i class="fas fa-comments-dollar me-2"></i> Live Chat</a></li>
            </ul>
            <div class="nav-item mt-auto ">
                <button type="submit" class="text-danger border-0 bg-transparent p-0 w-100 text-start mt-1">
                    <a href="/home/index" class="border-0 text-danger" style="text-decoration: none;"><i class="fas fa-sign-out-alt fa-fw me-2"></i> Về trang chủ</a>
                </button>
            </div>
        </div>
        <!-- Modal hiển thị ảnh phóng to -->
        <div id="imageModal" class="image-modal" style="display: none;">
            <span class="close-modal">&times;</span>
            <img class="modal-content" id="modalImage">
        </div>

        <div class="main-content flex-grow-1">
            <h2 class="mb-4">Live Chat</h2>

            <div id="chat-container">
                <div id="user-list-container">
                    <div id="user-list-header">Khách đang chờ</div>
                    <ul id="user-list">
                    </ul>
                </div>

                <div id="chat-window">
                    <div id="chat-window-header">
                        Chọn một khách để bắt đầu...
                    </div>
                    <div id="messages">
                    </div>
                    <div id="reply-area">
                        <input type="file" id="image-input" accept="image/*" style="display:none;">
                        <button id="image-btn" class="btn btn-outline-secondary me-2">
                            <i class="fas fa-image"></i>
                        </button>
                        <input type="text" id="reply-input" class="form-control" placeholder="Nhập tin nhắn..." disabled>
                        <button id="reply-send-btn" class="btn btn-primary" disabled><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
                const connection = new signalR.HubConnectionBuilder()
                    .withUrl("/Hubs/ChatHub")
                    .withAutomaticReconnect()
                    .build();

                let currentUser = null;
                let userList = [];

                connection.start().then(() => {
                    console.log("✅ Connected to ChatHub");
                    loadUserList();
                }).catch(err => console.error(err));

                // 🧩 Tải danh sách khách hàng đã chat
                async function loadUserList() {
                    try {
                        const res = await fetch('/QuanLyND/QuanLyHoTro/clients');
                        if (!res.ok) throw new Error("Không tải được danh sách khách");
                        userList = await res.json();
                    } catch {
                        userList = [
                            { id: "user1", name: "Khách A" },
                            { id: "user2", name: "Khách B" }
                        ];
                    }
                    renderUserList();
                }

                // 🧩 Hiển thị danh sách khách hàng
                function renderUserList() {
                    const ul = document.getElementById('user-list');
                    ul.innerHTML = '';
                    userList.forEach(u => {
                        const li = document.createElement('li');
                        li.textContent = u.name;
                        li.onclick = () => selectUser(u);
                        ul.appendChild(li);
                    });
                }

                // 🧩 Chọn 1 khách để chat
                function selectUser(u) {
                    currentUser = u;
                    document.querySelectorAll('#user-list li').forEach(li => li.classList.remove('active'));
                    const selected = [...document.querySelectorAll('#user-list li')]
                        .find(li => li.textContent === u.name);
                    if (selected) selected.classList.add('active');

                    document.getElementById('chat-window-header').textContent = "Đang chat với " + u.name;
                    document.getElementById('reply-input').disabled = false;
                    document.getElementById('reply-send-btn').disabled = false;

                    loadMessages(u.id);
                }

                // 🧩 Chuẩn hóa thời gian theo giờ Việt Nam
                       function formatVietnamTime(sentTime = null) {
                    if (!sentTime) return "";

                    const date = new Date(sentTime);
                    if (isNaN(date)) return "";

                    // ✅ Format theo giờ và ngày Việt Nam
                    const timeString = date.toLocaleTimeString("vi-VN", {
                        hour: "2-digit",
                        minute: "2-digit",
                    });

                    const dateString = date.toLocaleDateString("vi-VN", {
                        day: "2-digit",
                        month: "2-digit",
                        year: "numeric",
                    });

                    // ✅ Luôn hiển thị cả ngày và giờ
                    return `${timeString} • ${dateString}`;
                }

                // 🧩 Tải lịch sử tin nhắn từ SQL
                async function loadMessages(userId) {
                    const messagesBox = document.getElementById("messages");
                    messagesBox.innerHTML = "<p class='text-muted'>Đang tải...</p>";

                    try {
                        const res = await fetch(`/QuanLyND/QuanLyHoTro/history/${userId}`);
                        if (!res.ok) throw new Error("Không tải được tin nhắn");
                        const data = await res.json();

                        messagesBox.innerHTML = "";

                        if (data.length === 0) {
                            messagesBox.innerHTML = "<p class='text-muted'>Chưa có tin nhắn nào.</p>";
                            return;
                        }

                        data.forEach(m => {
                            const role = m.isFromAdmin ? "admin" : "user";
                                    if (m.imageUrl) {
                        addImageMessage(role, m.imageUrl, m.sentTime);
                    }

                    if (m.message && m.message.trim() !== "") {
                        addMessage(role, m.message, m.sentTime);
                    }
                        });

                    } catch (err) {
                        console.error(err);
                        messagesBox.innerHTML = "<p class='text-danger'>Lỗi khi tải tin nhắn.</p>";
                    }
                }

                const adminName = "@(User.Identity?.Name ?? "Admin")".trim();

                // 🧩 Khi admin gửi tin
                         function sendMessage() {
                        const messageInput = document.getElementById("reply-input");
                        const message = messageInput.value.trim();
                        if (!message || !currentUser) return;

                        // Gửi realtime
                        connection.invoke("SendReplyToUser", currentUser.name, message)
                            .catch(err => console.error(err.toString()));

                        // Lưu vào DB
                        fetch("/QuanLyND/QuanLyHoTro/SaveMessage", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                senderId: adminName,
                                receiverId: currentUser.id,
                                senderName: adminName,
                                message: message,
                                imageUrl: null, // ❌ Không gửi image khi chỉ là tin nhắn văn bản
                                isFromAdmin: true
                            })
                        })
                        .then(res => {
                            if (!res.ok) console.error("❌ Không lưu được tin nhắn");
                            else console.log("💾 Tin nhắn đã lưu vào DB");
                        })
                        .catch(err => console.error("Lỗi khi lưu tin nhắn:", err));

                        // Hiển thị ngay trên giao diện
                        addMessage("admin", message, new Date().toISOString());
                        messageInput.value = "";
                    }

                // 🧩 Hiển thị tin nhắn (giống user)
                function addMessage(senderRole, message, sentTime = null) {
                    const messagesDiv = document.getElementById("messages");
                    const msgDiv = document.createElement("div");
                    msgDiv.classList.add("message", senderRole);

                    msgDiv.innerHTML = `
                        <div class="bubble">
                            <p>${message}</p>
                            <span class="time">${formatVietnamTime(sentTime)}</span>
                        </div>
                    `;

                    messagesDiv.appendChild(msgDiv);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }

                const sendButton = document.getElementById("reply-send-btn");
                const messageInput = document.getElementById("reply-input");

                sendButton.addEventListener("click", sendMessage);
                messageInput.addEventListener("keypress", function (e) {
                    if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                        // 🧩 Khi click nút ảnh -> mở hộp chọn ảnh
                document.getElementById("image-btn").addEventListener("click", () => {
                    document.getElementById("image-input").click();
                });

                // 🧩 Khi chọn ảnh
                document.getElementById("image-input").addEventListener("change", async function () {
                    const file = this.files[0];
                    if (!file || !currentUser) return;

                    // Hiển thị ảnh trước khi upload
                    const previewUrl = URL.createObjectURL(file);
                    addImageMessage("admin", previewUrl, new Date().toISOString(), true);

                    const formData = new FormData();
                    formData.append("file", file);
                    formData.append("senderId", adminName);
                    formData.append("receiverId", currentUser.id);
                    formData.append("senderName", adminName);
                    formData.append("isFromAdmin", true);

                    try {
                                                        const res = await fetch("/QuanLyND/QuanLyHoTro/upload", {
                            method: "POST",
                            body: formData
                        });

                        if (!res.ok) throw new Error("Không upload được ảnh");
                        const result = await res.json();

                        // Gửi realtime cho user
                        connection.invoke("SendImageToUser", currentUser.name, result.imageUrl)
                            .catch(err => console.error(err.toString()));

                        console.log("📸 Ảnh đã gửi thành công:", result.imageUrl);
                    } catch (err) {
                        console.error("Lỗi khi upload ảnh:", err);
                    }

                    // Reset input
                    this.value = "";
                });

                // 🧩 Hàm hiển thị ảnh trong khung chat
                       function addImageMessage(senderRole, imageUrl, sentTime = null, isPreview = false) {
                    const messagesDiv = document.getElementById("messages");
                    const msgDiv = document.createElement("div");
                    msgDiv.classList.add("message", senderRole);

                    msgDiv.innerHTML = `
                                <div class="image-bubble">
                            <img src="${imageUrl}" class="chat-image" alt="Ảnh gửi" />
                            <div class="time text-muted">${formatVietnamTime(sentTime)}</div>
                        </div>
                    `;

                    messagesDiv.appendChild(msgDiv);
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }

                // Khi click vào ảnh => mở modal
        document.addEventListener("click", function (e) {
            if (e.target.classList.contains("chat-image")) {
                const modal = document.getElementById("imageModal");
                const modalImg = document.getElementById("modalImage");
                modal.style.display = "block";
                modalImg.src = e.target.src;
            }
        });

        // Khi nhấn nút đóng hoặc click ra ngoài => đóng modal
        document.querySelector(".close-modal").onclick = function () {
            document.getElementById("imageModal").style.display = "none";
        };

        document.getElementById("imageModal").onclick = function (e) {
            if (e.target.id === "imageModal") {
                document.getElementById("imageModal").style.display = "none";
            }
        };
                let lastMessageCount = 0;

                async function smartReload(userId) {
                    const res = await fetch(`/QuanLyND/QuanLyHoTro/history/${userId}`);
                    const data = await res.json();
                    if (data.length !== lastMessageCount) {
                        lastMessageCount = data.length;
                        loadMessages(userId); // Chỉ reload khi có tin nhắn mới
                    }
                }

                setInterval(() => {
                    if (currentUser) smartReload(currentUser.id);
                        }, 1000);

    </script>
</body>
</html>