@* SỬA 1: Đổi Model *@
@model DACS.Models.ViewModels.SanPhamDetailsViewModel
@using DACS.Models

@{
    // SỬA 2: Lấy dữ liệu từ Model, không cần ViewData
    ViewData["Title"] = $"Chi tiết: {Model.SanPham.TenSanPham}";
    var soLuongTonKho = Model.TotalStock; // <<< SỬA
    var isFavorite = (bool)(ViewData["IsFavorite"] ?? false);
    string heartIconClass = isFavorite ? "fa-solid fa-heart text-danger" : "fa-regular fa-heart";
    var relatedProducts = ViewData["RelatedProducts"] as List<DACS.Models.SanPham> ?? new List<DACS.Models.SanPham>();
    var reviewMessage = TempData["ReviewMessage"] as string;
    var currentUserMKhachHang = ViewData["CurrentUser_M_KhachHang"] as string;
}

<div class="container mt-5 mb-5">
    @if (!string.IsNullOrEmpty(reviewMessage))
    {
        <div class="alert @(reviewMessage.StartsWith("Lỗi") || reviewMessage.StartsWith("Thông báo:") ? "alert-warning" : "alert-success")" role="alert">
            @reviewMessage
        </div>
    }
    <div class="row">
        <div class="col-lg-6 mb-4 mb-lg-0">
            @* (Phần hiển thị ảnh giữ nguyên) *@
            <div class="product-image-main text-center mb-3">
                <img src="@Url.Content(Model.SanPham.AnhSanPham ?? "~/images/placeholder.png")" alt="@Model.SanPham.TenSanPham" id="mainProductImage" style="max-width: 100%; height: auto; object-fit: contain; max-height: 400px;">
            </div>
        </div>

        <div class="col-lg-6">
            @* SỬA 3: Đổi Model thành Model.SanPham *@
            <h1>@Model.SanPham.TenSanPham</h1>

            @* (Phần sao đánh giá giữ nguyên) *@

            <p><small class="text-muted">Mã SP: @Model.SanPham.M_SanPham</small></p>
            <p><small class="text-muted">Loại: @(Model.SanPham.LoaiSanPham?.TenLoai ?? "N/A") | ĐVT: @(Model.SanPham.DonViTinh?.TenLoaiTinh ?? "N/A")</small></p>

            @* <p><small class="text-muted">Hạn sử dụng: @Model.SanPham.HanSuDung.ToString("dd/MM/yyyy")</small></p> *@

            <p class="h3 text-danger fw-bold mb-3">Giá: @Model.SanPham.Gia.ToString("N0")₫</p>

            @if (soLuongTonKho > 0 && Model.SanPham.TrangThai.Equals("Còn hàng", StringComparison.OrdinalIgnoreCase))
            {
                <span class="badge bg-success mb-3">Còn hàng (Tổng: @soLuongTonKho.ToString("N0") kg)</span>
            }
            else
            {
                <span class="badge bg-danger mb-3">Hết hàng</span>
            }

            @* (Code hiển thị mô tả ngắn giữ nguyên) *@

            <form asp-controller="ShoppingCart" asp-action="AddToCart" method="post">
                <input type="hidden" name="productId" value="@Model.SanPham.M_SanPham" />
                <div class="d-flex align-items-center mb-4">
                    <label for="khoiluongInput" class="form-label me-3 mb-0">Khối lượng (@(Model.SanPham.DonViTinh?.TenLoaiTinh ?? "kg")):</label>

                    @* SỬA 5: Cập nhật 'max' để lấy từ soLuongTonKho (là Model.TotalStock) *@
                    <input type="number"
                           name="khoiluong"
                           id="khoiluongInput"
                           value="1"
                           min="1"
                           max="@soLuongTonKho.ToString("F0")"
                           class="form-control"
                           style="width: 100px;"
                           @(soLuongTonKho > 0 ? "" : "disabled") />

                    <button type="button" id="btnWishlist" class="btn btn-outline-danger ms-3" data-id="@Model.SanPham.M_SanPham" title="Thêm/Xóa yêu thích">
                        <i id="wishlistIcon" class="fa @heartIconClass"></i>
                    </button>
                </div>
                <div class="d-grid gap-2 d-sm-flex">
                    @if (soLuongTonKho > 0 && Model.SanPham.TrangThai.Equals("Còn hàng", StringComparison.OrdinalIgnoreCase))
                    {
                        <button type="submit" class="btn btn-primary btn-lg">Thêm vào giỏ</button>
                    }
                    else
                    {
                        <button type="button" class="btn btn-secondary btn-lg" disabled>Hết hàng</button>
                    }
                </div>
            </form>

            <div class="mt-4">
                <h5>Các lô hàng hiện có:</h5>
                @if (Model.AvailableLots.Any())
                {
                    <table class="table table-sm table-bordered" style="font-size: 0.9rem;">
                        <thead class="table-light">
                            <tr>
                                <th>Mã Lô</th>
                                <th>Ngày Nhập (FIFO)</th>
                                <th>Hạn Sử Dụng</th>
                                <th>Còn Lại</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var lot in Model.AvailableLots)
                            {
                                <tr>
                                    <td>@lot.MaLoTonKho</td>
                                    <td>@lot.NgayNhapKho.ToString("dd/MM/yyyy")</td>
                                    <td>@(lot.HanSuDung?.ToString("dd/MM/yyyy") ?? "N/A")</td>
                                    <td>@lot.KhoiLuongConLai.ToString("N0") kg</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="text-muted">Không còn lô hàng nào trong kho.</p>
                }
            </div>
        </div>
    </div>

    @* (Phần còn lại của trang: Tabs, Đánh giá, Sản phẩm liên quan... giữ nguyên) *@
    @* (Bạn chỉ cần đảm bảo @Model.SanPham.ChiTietDanhGias... thay vì @Model.ChiTietDanhGias...) *@
    <div class="row mt-5">
        <div class="col-12">
            <ul class="nav nav-tabs" id="productTab" role="tablist">
                @* (Thêm NavTabs nếu cần) *@
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab" aria-controls="description" aria-selected="true">Mô Tả</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab" aria-controls="reviews" aria-selected="false">Đánh Giá</button>
                </li>
            </ul>
            <div class="tab-content pt-4" id="productTabContent">
                <div class="tab-pane fade show active" id="description" role="tabpanel">
                    @Html.Raw(Model.SanPham.MoTa?.Replace("\n", "<br />") ?? "<p>Chưa có mô tả.</p>")
                </div>
                <div class="tab-pane fade" id="reviews" role="tabpanel">
                    <h4>Đánh giá từ khách hàng</h4>
                    <div class="mb-4">
                        @if (Model.SanPham.ChiTietDanhGias != null && Model.SanPham.ChiTietDanhGias.Any())
                        {
                            @* (Lặp qua các review: Model.SanPham.ChiTietDanhGias) *@
                        }
                        else
                        {
                            <p>Chưa có đánh giá nào.</p>
                        }
                    </div>
                    <hr class="my-4">
                    <h5>Viết đánh giá của bạn</h5>
                    @if (User.Identity.IsAuthenticated)
                    {
                        <form id="reviewForm" asp-action="SubmitReview" asp-controller="DS_SP" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="M_SanPham" value="@Model.SanPham.M_SanPham" />
                            @* (Thêm input M_KhachHang nếu cần) *@
                            <div class="mb-3">
                                <label class="form-label">Mức độ hài lòng</label>
                                <div id="ratingInput" class="rating-stars">
                                    <i class="fa-regular fa-star interactive-star" data-value="1"></i>
                                    <i class="fa-regular fa-star interactive-star" data-value="2"></i>
                                    <i class="fa-regular fa-star interactive-star" data-value="3"></i>
                                    <i class="fa-regular fa-star interactive-star" data-value="4"></i>
                                    <i class="fa-regular fa-star interactive-star" data-value="5"></i>
                                    <input type="hidden" name="MucDoHaiLong" id="ratingValue" value="0" required />
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="reviewComment" class="form-label">Nhận xét</label>
                                <textarea class="form-control" id="reviewComment" name="MoTa_DanhGia" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Gửi đánh giá</button>
                        </form>
                    }
                    else
                    {
                        <p>Vui lòng <a asp-area="Identity" asp-page="/Account/Login" asp-route-returnUrl="@Context.Request.Path">đăng nhập</a> để gửi đánh giá.</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @* (Giữ nguyên toàn bộ JavaScript của bạn) *@
}