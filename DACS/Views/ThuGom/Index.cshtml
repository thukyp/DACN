@model DACS.Models.ViewModels.ThuGomViewModel
@{
    ViewData["Title"] = "Tạo Yêu Cầu Thu Gom Phụ Phẩm";
    // Layout = "_YourLayout"; // Đảm bảo dùng đúng Layout
}

<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - YourAppName</title> @* Thay YourAppName *@
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@100..900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #8D6E63;
            --light-bg: #F9FBE7;
            --dark-text: #2E2E2E;
        }

        h1 {
            color: var(--primary);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--light-bg);
            color: var(--dark-text);
        }

        .card-header {
            font-weight: 600;
        }

        .form-label {
            font-weight: 500;
        }

        .field-validation-error {
            color: #dc3545;
            font-size: 0.875em;
        }

        .input-validation-error {
            border-color: #dc3545;
        }

        .validation-summary-errors ul {
            padding-left: 20px;
            margin-bottom: 0;
            color: #dc3545;
        }

        select:disabled {
            background-color: #e9ecef;
        }
    </style>
</head>
<body>
    <div class="container mt-4 mb-5">
        <h1 class="mb-4 text-center">Tạo Yêu Cầu Thu Gom Phụ Phẩm</h1>

        <div asp-validation-summary="ModelOnly" class="alert alert-danger validation-summary-errors" role="alert"></div>

        <form asp-action="Index" asp-controller="ThuGom" method="post" enctype="multipart/form-data" id="mainThuGomForm">
            @Html.AntiForgeryToken()

            <div class="row g-4">
                @* ----- CỘT THÔNG TIN NGƯỜI CUNG CẤP ----- *@
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-secondary text-white">
                            <i class="fas fa-user me-2"></i> NGƯỜI CUNG CẤP
                        </div>
                        <div class="card-body">
                            @* (Các trường: Tên, SĐT, Tỉnh, Huyện, Xã, Đường, Thời gian, Ghi chú... giữ nguyên) *@
                            <div class="mb-3">
                                <label asp-for="SupplierName" class="form-label"></label> <span class="text-danger">*</span>
                                <input asp-for="SupplierName" class="form-control" placeholder="Nhập tên người liên hệ">
                                <span asp-validation-for="SupplierName" class="text-danger field-validation-error"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="SupplierPhone" class="form-label"></label> <span class="text-danger">*</span>
                                <input asp-for="SupplierPhone" type="tel" class="form-control" placeholder="Nhập số điện thoại liên hệ">
                                <span asp-validation-for="SupplierPhone" class="text-danger field-validation-error"></span>
                            </div>
                            <hr>
                            <h5 class="mb-3">Địa chỉ lấy phụ phẩm <span class="text-danger">*</span></h5>
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label asp-for="SupplierProvince" class="form-label"></label>
                                    <select asp-for="SupplierProvince" id="provinceSelectThuGom" class="form-select" asp-items="Model.ProvinceOptions">
                                        <option value="">-- Chọn Tỉnh/Thành phố --</option>
                                    </select>
                                    <span asp-validation-for="SupplierProvince" class="text-danger field-validation-error"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="SupplierDistrict" class="form-label"></label>
                                    <select asp-for="SupplierDistrict" id="districtSelectThuGom" class="form-select" asp-items="Model.DistrictOptions">
                                        <option value="">-- Chọn Quận/Huyện --</option>
                                    </select>
                                    <span asp-validation-for="SupplierDistrict" class="text-danger field-validation-error"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="SupplierWard" class="form-label"></label>
                                    <select asp-for="SupplierWard" id="wardSelectThuGom" class="form-select" asp-items="Model.WardOptions">
                                        <option value="">-- Chọn Xã/Phường --</option>
                                    </select>
                                    <span asp-validation-for="SupplierWard" class="text-danger field-validation-error"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="SupplierStreet" class="form-label"></label>
                                    <input asp-for="SupplierStreet" class="form-control" placeholder="Số nhà, Tên đường, Ấp, Thôn...">
                                    <span asp-validation-for="SupplierStreet" class="text-danger field-validation-error"></span>
                                </div>
                            </div>
                            <hr />
                            <div class="mb-3">
                                <label asp-for="PickupReadyTime" class="form-label"></label> <span class="text-danger">*</span>
                                <input asp-for="PickupReadyTime" type="datetime-local" class="form-control">
                                <span asp-validation-for="PickupReadyTime" class="text-danger field-validation-error"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="SupplierNotes" class="form-label"></label>
                                <textarea asp-for="SupplierNotes" class="form-control" rows="2" placeholder="Ghi chú thêm..."></textarea>
                                <span asp-validation-for="SupplierNotes" class="text-danger field-validation-error"></span>
                            </div>
                        </div>
                    </div>
                </div>

                @* ----- CỘT THÔNG TIN PHỤ PHẨM ----- *@
                <div class="col-md-6">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-secondary text-white">
                            <i class="fas fa-box-open me-2"></i> THÔNG TIN PHỤ PHẨM
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label asp-for="M_LoaiSP" class="form-label"></label> <span class="text-danger">*</span>
                                <select asp-for="M_LoaiSP" class="form-select" asp-items="Model.LoaiSanPhamOptions" id="loaiSanPhamSelect">
                                    <option selected disabled value="">Chọn loại sản phẩm...</option>
                                </select>
                                <span asp-validation-for="M_LoaiSP" class="text-danger field-validation-error"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="M_SanPham" class="form-label"></label> <span class="text-danger">*</span>
                                <select asp-for="M_SanPham" class="form-select" asp-items="Model.SanPhamOptions" id="sanPhamSelect">
                                    <option selected disabled value="">-- Vui lòng chọn Loại Sản Phẩm trước --</option>
                                </select>
                                <span asp-validation-for="M_SanPham" class="text-danger field-validation-error"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="ByproductDescription" class="form-label"></label>
                                <textarea asp-for="ByproductDescription" class="form-control" rows="2" placeholder="Mô tả chi tiết..."></textarea>
                                <span asp-validation-for="ByproductDescription" class="text-danger field-validation-error"></span>
                            </div>
                            <div class="row g-3 mb-3">
                                <div class="col-sm-6">
                                    <label asp-for="ByproductQuantity" class="form-label"></label> <span class="text-danger">*</span>
                                    <input asp-for="ByproductQuantity" type="number" step="any" class="form-control" placeholder="Nhập số lượng" min="0.01">
                                    <span asp-validation-for="ByproductQuantity" class="text-danger field-validation-error"></span>
                                </div>
                                <div class="col-sm-6">
                                    <label asp-for="ByproductUnit" class="form-label"></label> <span class="text-danger">*</span>
                                    <select asp-for="ByproductUnit" class="form-select" asp-items="Model.DonViTinhOptions">
                                        <option selected disabled value="">Chọn ĐVT...</option>
                                    </select>
                                    <span asp-validation-for="ByproductUnit" class="text-danger field-validation-error"></span>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label asp-for="ByproductValue" class="form-label"></label>
                                <div class="input-group">
                                    <input asp-for="ByproductValue" type="number" step="any" class="form-control" placeholder="Nhập giá trị" min="0">
                                    <span class="input-group-text">VNĐ</span>
                                </div>
                                <span asp-validation-for="ByproductValue" class="text-danger field-validation-error"></span>
                            </div>
                            <hr>
                            <h5 class="mb-3">Đặc tính phụ phẩm</h5>
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="form-check mb-2"><input asp-for="CharBulky" class="form-check-input" type="checkbox"><label asp-for="CharBulky" class="form-check-label"></label></div>
                                    <div class="form-check mb-2"><input asp-for="CharWet" class="form-check-input" type="checkbox"><label asp-for="CharWet" class="form-check-label"> Ẩm / Ướt</label></div>
                                    <div class="form-check mb-2"><input asp-for="CharDry" class="form-check-input" type="checkbox"><label asp-for="CharDry" class="form-check-label"> Khô</label></div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="form-check mb-2"><input asp-for="CharMoisture" class="form-check-input" type="checkbox"><label asp-for="CharMoisture" class="form-check-label"> Độ ẩm cao</label></div>
                                    <div class="form-check mb-2"><input asp-for="CharImpure" class="form-check-input" type="checkbox"><label asp-for="CharImpure" class="form-check-label"> Tạp chất</label></div>
                                    <div class="form-check mb-2"><input asp-for="CharProcessed" class="form-check-input" type="checkbox"><label asp-for="CharProcessed" class="form-check-label"> Đã xử lý</label></div>
                                </div>
                            </div>
                            <div class="mt-3">
                                <label asp-for="ByproductImages" class="form-label"></label>
                                <input asp-for="ByproductImages" type="file" class="form-control" multiple accept="image/*">
                                <span asp-validation-for="ByproductImages" class="text-danger field-validation-error"></span>
                            </div>
                        </div>
                    </div>
                </div>

                @* ----- CỘT SUBMIT VÀ CAM KẾT ----- *@
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-body text-center">

                            <div class="mb-3 form-check" style="max-width: 600px; margin-left: auto; margin-right: auto; text-align: left;">
                                <input asp-for="DaDongYCamKet" type="checkbox" class="form-check-input" />
                                <label class="form-check-label fw-bold" for="DaDongYCamKet">
                                    Tôi đã đọc và đồng ý với
                                    <a href="#" data-bs-toggle="modal" data-bs-target="#camKetModal">
                                        Điều Khoản Cam Kết Cung Cấp Phụ Phẩm.
                                    </a>
                                </label>
                                <span asp-validation-for="DaDongYCamKet" class="text-danger field-validation-error d-block"></span>
                            </div>
                            <div class="d-flex justify-content-center flex-wrap gap-3 mt-3">
                                <button type="submit" class="btn btn-primary btn-lg"><i class="fas fa-paper-plane me-2"></i> Yêu cầu Thu gom</button>
                                <button type="reset" class="btn btn-outline-danger"><i class="fas fa-redo me-2"></i> Làm mới Form</button>
                            </div>
                        </div>
                    </div>
                </div>

                @* ----- MODAL CAM KẾT (Cửa sổ bật lên) ----- *@
                <div class="modal fade" id="camKetModal" tabindex="-1" aria-labelledby="camKetModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="camKetModalLabel">BẢN CAM KẾT CUNG CẤP PHỤ PHẨM NÔNG NGHIỆP</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p>Bằng việc đồng ý, Bên Cung Cấp (Bên A) cam kết tuân thủ các điều khoản sau đây:</p>
                                <h5 class="mt-4">Điều 1: Tính chính xác và trung thực của thông tin</h5>
                                <p>Bên A cam kết mọi thông tin được kê khai trong "Yêu cầu Thu gom" là hoàn toàn trung thực, bao gồm: Loại Sản Phẩm, Sản Phẩm Cụ Thể, Số lượng/Khối lượng ước tính, và Hình ảnh cung cấp là hình ảnh thật của lô hàng.</p>
                                <h5>Điều 2: Cam kết về đặc tính vật lý</h5>
                                <p>Bên A cam kết phụ phẩm cung cấp đúng với các đặc tính vật lý đã mô tả (ví dụ: nếu chọn "Khô", phụ phẩm không được ướt, ẩm mốc).</p>
                                <h5>Điều 3: Cam kết về độ tinh sạch và không pha trộn</h5>
                                <p>Bên A cam kết phụ phẩm không bị cố ý trộn lẫn đất, đá, cát, rác thải, hoặc các vật lạ khác nhằm tăng khối lượng. Phụ phẩm không chứa các chất cấm hoặc hóa chất độc hại vượt ngưỡng cho phép.</p>
                                <h5>Điều 4: Cam kết về thời gian và chất lượng tại điểm thu gom</h5>
                                <p>Bên A cam kết phụ phẩm phải ở trạng thái chất lượng như đã mô tả (không bị thối rữa, nấm mốc phát sinh) tại đúng "Thời gian sẵn sàng lấy" đã hẹn.</p>
                                <h5 class="text-danger">Điều 5: Điều khoản xử lý vi phạm và hoàn trả</h5>
                                <p class="fw-bold">
                                    Bên A hiểu rõ và đồng ý rằng: Bên Thu Gom (Bên B) có quyền <strong>từ chối thu gom</strong> ngay tại chỗ nếu phát hiện bất kỳ vi phạm nào.
                                    Trường hợp vi phạm chỉ được phát hiện sau khi đã vận chuyển về kho, Bên B có quyền <strong>yêu cầu hoàn trả</strong> toàn bộ lô hàng. Bên A phải nhận lại lô hàng và chịu mọi chi phí vận chuyển phát sinh.
                                </p>
                                <hr />
                                <p class="fw-bold">Tôi, đại diện cho Bên A, xác nhận đã đọc, hiểu rõ và đồng ý tuân thủ tất cả các điều khoản được nêu trong bản cam kết này.</p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đã hiểu</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    @* --- SCRIPTS --- *@
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>

    @await Html.PartialAsync("_ValidationScriptsPartial") @* Script validation *@

    @* Script AJAX cho dropdown địa chỉ VÀ sản phẩm *@
    <script>
        $(document).ready(function () {
            // === LOGIC ĐỊA CHỈ ===
            const provinceSelect = $('#provinceSelectThuGom');
            const districtSelect = $('#districtSelectThuGom');
            const wardSelect = $('#wardSelectThuGom');

            function resetDropdown(dropdown, defaultText, disabled) {
                dropdown.empty().append($('<option>', {
                    value: '',
                    text: defaultText
                })).prop('disabled', disabled);
                 dropdown.val('');
            }
            function enableDropdown(dropdown) {
                 dropdown.prop('disabled', false);
            }

            // Khởi tạo (Nếu là postback lỗi, không reset)
            if (districtSelect.find('option').length <= 1) {
                 resetDropdown(districtSelect, '-- Chọn Quận/Huyện --', true);
            }
            if (wardSelect.find('option').length <= 1) {
                resetDropdown(wardSelect, '-- Chọn Xã/Phường --', true);
            }

            // Sự kiện change Tỉnh/TP
            provinceSelect.on('change', function () {
                const selectedProvinceId = $(this).val();
                resetDropdown(districtSelect, '-- Đang tải Quận/Huyện... --', true);
                resetDropdown(wardSelect, '-- Chọn Xã/Phường --', true);

                if (selectedProvinceId) {
                    // ================= SỬA LỖI 3: Đổi Controller và Action cho AJAX =================
                    const url = '@Url.Action("GetDistricts", "ThuGom")' + '?provinceId=' + selectedProvinceId;
                    $.getJSON(url)
                        .done(function (districts) {
                             if (districts && districts.length > 0) {
                                 resetDropdown(districtSelect, '-- Chọn Quận/Huyện --', false);
                                 $.each(districts, function (index, district) {
                                     districtSelect.append($('<option>', { value: district.id, text: district.name }));
                                 });
                             } else {
                                  resetDropdown(districtSelect, '-- Không có Quận/Huyện --', true);
                             }
                        })
                        .fail(function () {
                            resetDropdown(districtSelect, 'Lỗi tải Quận/Huyện', true);
                        });
                }
            });

            // Sự kiện change Quận/Huyện
            districtSelect.on('change', function () {
                const selectedDistrictId = $(this).val();
                resetDropdown(wardSelect, '-- Đang tải Xã/Phường... --', true);

                if (selectedDistrictId) {
                     // ================= SỬA LỖI 3: Đổi Controller và Action cho AJAX =================
                     const url = '@Url.Action("GetWards", "ThuGom")' + '?districtId=' + selectedDistrictId;
                     $.getJSON(url)
                         .done(function (wards) {
                             if (wards && wards.length > 0) {
                                 resetDropdown(wardSelect, '-- Chọn Xã/Phường --', false);
                                 $.each(wards, function (index, ward) {
                                     wardSelect.append($('<option>', { value: ward.id, text: ward.name }));
                                 });
                             } else {
                                 resetDropdown(wardSelect, '-- Không có Xã/Phường --', true);
                             }
                         })
                         .fail(function () {
                             resetDropdown(wardSelect, 'Lỗi tải Xã/Phường', true);
                         });
                }
            });

            // === LOGIC MỚI CHO SẢN PHẨM ===
            const loaiSanPhamSelect = $('#loaiSanPhamSelect');
            const sanPhamSelect = $('#sanPhamSelect');

            // Hàm reset dropdown sản phẩm
            function resetSanPhamDropdown(text, disabled) {
                sanPhamSelect.empty().append($('<option>', {
                    value: '',
                    text: text
                })).prop('disabled', disabled);
                sanPhamSelect.val(''); // Đảm bảo giá trị rỗng
            }

            // Khởi tạo (Nếu là postback lỗi, không reset)
            if (sanPhamSelect.find('option').length <= 1) {
                 resetSanPhamDropdown('-- Vui lòng chọn Loại Sản Phẩm trước --', true);
            }

            // Sự kiện change Loại Sản Phẩm
            loaiSanPhamSelect.on('change', function () {
                const selectedLoaiSPId = $(this).val();

                if (selectedLoaiSPId) {
                    resetSanPhamDropdown('-- Đang tải Sản Phẩm... --', true);

                    // Gọi hàm AJAX "GetSanPhamsByLoai" trong ThuGomController
                    const url = '@Url.Action("GetSanPhamsByLoai", "ThuGom")' + '?maLoaiSP=' + selectedLoaiSPId;

                    $.getJSON(url)
                        .done(function (sanPhams) {
                            if (sanPhams && sanPhams.length > 0) {
                                resetSanPhamDropdown('-- Chọn sản phẩm --', false);
                                $.each(sanPhams, function (index, sanPham) {
                                    sanPhamSelect.append($('<option>', { value: sanPham.id, text: sanPham.name }));
                                });
                            } else {
                                resetSanPhamDropdown('-- Không có sản phẩm cho loại này --', true);
                            }
                        })
                        .fail(function () {
                            resetSanPhamDropdown('Lỗi tải sản phẩm', true);
                        });
                } else {
                    resetSanPhamDropdown('-- Vui lòng chọn Loại Sản Phẩm trước --', true);
                }
            });
            // === KẾT THÚC LOGIC MỚI ===

        });
    </script>

</body>
</html>